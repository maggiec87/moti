<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“šè«æç¬”è®°</title>
    <style>
        :root {
            --primary-color: #3a506b;
            --bg-color: #ffffff;
            --section-bg: #f8f9fa;
            --border-color: #e9ecef;
            --accent-color: #5fac81;
            --warn-color: #e57373;
            --edit-color: #4a90e2;
            --text-main: #2d3436;
            --text-sub: #636e72;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            line-height: 1.5;
        }

        .container { max-width: 700px; margin: 0 auto; }

        header { text-align: center; padding: 20px 0; border-bottom: 2px solid var(--primary-color); margin-bottom: 20px; }
        header h1 { margin: 0; font-size: 22px; color: var(--primary-color); }
        header p { margin: 5px 0 0; font-size: 12px; color: var(--text-sub); letter-spacing: 2px; }

        .editor-box {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 25px;
        }

        .date-import-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .date-input-group { display: flex; align-items: center; gap: 8px; flex: 1; }
        
        input[type="date"] {
            border: 1px solid #ced4da;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            color: var(--primary-color);
            background: #fff;
        }

        .lunar-info { font-size: 12px; color: var(--text-sub); white-space: nowrap; }

        .field-group { margin-bottom: 12px; }
        .field-group label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: var(--primary-color); }
        
        textarea {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
            font-size: 15px;
            resize: vertical;
            background: #fff;
        }

        .btn-main {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .history-controls {
            margin-top: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--primary-color);
        }
        
        .history-header-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .history-title { font-weight: bold; font-size: 18px; }

        .toolbar-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .filter-bar {
            display: flex;
            align-items: center;
            background: var(--section-bg);
            padding: 8px;
            gap: 5px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
        }
        .filter-bar input { border: 1px solid #ddd; padding: 4px; font-size: 12px; flex: 1; min-width: 90px; }

        .action-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-sub {
            flex: 1;
            min-width: 45px;
            padding: 8px 5px;
            font-size: 12px;
            border: 1px solid var(--border-color);
            background: #fff;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
        }

        .note-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .note-date-box .d-val { font-weight: bold; color: var(--primary-color); font-size: 14px; }
        .note-date-box .l-val { font-size: 12px; color: var(--text-sub); }

        .note-ops { display: flex; gap: 15px; }
        .op-text { font-size: 13px; cursor: pointer; text-decoration: underline; }
        .op-edit { color: var(--edit-color); }
        .op-del { color: var(--warn-color); }

        .note-content b { display: block; margin-top: 10px; font-size: 12px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .note-content p { margin: 4px 0 0; font-size: 15px; white-space: pre-wrap; color: var(--text-main); }

        #importFile { display: none; }

        @media (min-width: 480px) {
            .toolbar-grid { grid-template-columns: 2fr 1.5fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“š è«æç¬”è®°</h1>
        <p>MULTIVERSITY NOTES</p>
    </header>

    <div class="editor-box" id="editorArea">
        <div class="date-import-row">
            <div class="date-input-group">
                <input type="date" id="manualDate" onchange="updateLunarDisplay()">
                <span class="lunar-info" id="lunarDisplay"></span>
            </div>
            <button class="btn-sub" style="background: var(--primary-color); color: #fff; flex: 0 0 70px;" onclick="document.getElementById('importFile').click()">ğŸ“¤ å¯¼å…¥</button>
            <input type="file" id="importFile" accept=".csv" onclick="this.value=null" onchange="importCSV(this)">
        </div>

        <input type="hidden" id="editIndex" value="-1">
        
        <div class="field-group">
            <label>QUOTE</label>
            <textarea id="quote" placeholder="é‡‘å¥åŸå¥" rows="2"></textarea>
        </div>
        <div class="field-group">
            <label>INSIGHT</label>
            <textarea id="insight" placeholder="é‡‘å¥è¯ é‡Š" rows="2"></textarea>
        </div>
        <div class="field-group">
            <label>REFLECT</label>
            <textarea id="feeling" placeholder="æ„Ÿå’Œæ‚Ÿ" rows="2"></textarea>
        </div>

        <button class="btn-main" onclick="saveEntry()" id="saveBtn">ä¿å­˜ç¬”è®°</button>
    </div>

    <div class="history-controls">
        <div class="history-header-line">
            <div class="history-title">ğŸ“œ å†å²ç¬”è®°</div>
        </div>
        <div class="toolbar-grid">
            <div class="filter-bar">
                <button class="btn-sub" onclick="resetFilter(true)">å…¨éƒ¨</button>
                <input type="date" id="filterStart" onchange="renderEntries()">
                <span>-</span>
                <input type="date" id="filterEnd" onchange="renderEntries()">
                <button class="btn-sub" onclick="resetFilter(false)">é‡é€‰</button>
            </div>
            <div class="action-btns">
                <button class="btn-sub" onclick="exportCSV()">ğŸ“¥å¯¼å‡º</button>
                <button class="btn-sub" onclick="clearAll()">ğŸ—‘ï¸æ¸…ç©º</button>
                <button class="btn-sub" onclick="sharePage()">ğŸ”—åˆ†äº«</button>
            </div>
        </div>
    </div>

    <div id="entriesList"></div>
</div>

<script>
    let entries = JSON.parse(localStorage.getItem('moti_notes') || '[]');

    function getLunarDate(dateObj) {
        try {
            const options = { calendar: 'chinese', dateStyle: 'long' };
            const formatter = new Intl.DateTimeFormat('zh-Hans-CN-u-ca-chinese', options);
            const parts = formatter.format(dateObj).split('å¹´');
            return "å†œå†" + (parts[1] || parts[0]);
        } catch (e) { return ""; }
    }

    function updateLunarDisplay() {
        const val = document.getElementById('manualDate').value;
        if(!val) return;
        const d = new Date(val);
        const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        document.getElementById('lunarDisplay').innerText = `${days[d.getDay()]} | ${getLunarDate(d)}`;
    }

    function initDatePicker() {
        const now = new Date();
        const str = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        document.getElementById('manualDate').value = str;
        updateLunarDisplay();
    }

    function renderEntries() {
        const list = document.getElementById('entriesList');
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        list.innerHTML = '';

        const filtered = entries.filter(item => {
            if (start && item.dateRaw < start) return false;
            if (end && item.dateRaw > end) return false;
            return true;
        });

        if (filtered.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">æš‚æ— åŒ¹é…ç¬”è®°</p>';
            return;
        }

        filtered.forEach((item) => {
            const realIdx = entries.findIndex(e => e === item);
            const d = new Date(item.dateRaw);
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

            const div = document.createElement('div');
            div.className = 'note-item';
            div.innerHTML = `
                <div class="note-meta">
                    <div class="note-date-box">
                        <span class="d-val">${item.dateRaw}</span>
                        <span class="l-val">ï¼ˆ${days[d.getDay()]} ${getLunarDate(d)}ï¼‰</span>
                    </div>
                    <div class="note-ops">
                        <span class="op-text op-edit" onclick="editEntry(${realIdx})">ç¼–è¾‘</span>
                        <span class="op-text op-del" onclick="deleteEntry(${realIdx})">åˆ é™¤</span>
                    </div>
                </div>
                <div class="note-content">
                    <b>QUOTE</b><p>${item.quote || '-'}</p>
                    <b>INSIGHT</b><p>${item.insight || '-'}</p>
                    <b>REFLECT</b><p>${item.feeling || '-'}</p>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function resetFilter(shouldRender) {
        document.getElementById('filterStart').value = '';
        document.getElementById('filterEnd').value = '';
        if(shouldRender) renderEntries();
    }

    function saveEntry() {
        const dateRaw = document.getElementById('manualDate').value;
        const quote = document.getElementById('quote').value.trim();
        const insight = document.getElementById('insight').value.trim();
        const feeling = document.getElementById('feeling').value.trim();
        const editIndex = parseInt(document.getElementById('editIndex').value);

        if (!dateRaw || (!quote && !insight && !feeling)) return alert("è¯·å¡«å†™å†…å®¹åŠæ—¥æœŸ");

        const data = { dateRaw, quote, insight, feeling, timestamp: new Date(dateRaw).getTime() };

        if (editIndex > -1) {
            entries[editIndex] = data;
        } else {
            entries.unshift(data);
        }

        entries.sort((a, b) => b.timestamp - a.timestamp);
        localStorage.setItem('moti_notes', JSON.stringify(entries));
        resetEditor();
        renderEntries();
    }

    function editEntry(index) {
        const e = entries[index];
        document.getElementById('quote').value = e.quote;
        document.getElementById('insight').value = e.insight;
        document.getElementById('feeling').value = e.feeling;
        document.getElementById('manualDate').value = e.dateRaw;
        document.getElementById('editIndex').value = index;
        document.getElementById('saveBtn').innerText = "æ›´æ–°ç¬”è®°";
        updateLunarDisplay();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetEditor() {
        document.getElementById('editIndex').value = "-1";
        document.getElementById('saveBtn').innerText = "ä¿å­˜ç¬”è®°";
        document.getElementById('quote').value = '';
        document.getElementById('insight').value = '';
        document.getElementById('feeling').value = '';
        initDatePicker();
    }

    function deleteEntry(index) {
        if (confirm('ç¡®å®šåˆ é™¤?')) {
            entries.splice(index, 1);
            localStorage.setItem('moti_notes', JSON.stringify(entries));
            renderEntries();
        }
    }

    function clearAll() {
        if (confirm('ç¡®å®šæ¸…ç©ºå…¨éƒ¨? è¿™å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„æ•°æ®ï¼')) {
            entries = [];
            localStorage.removeItem('moti_notes');
            renderEntries();
        }
    }

    function sharePage() {
        navigator.clipboard.writeText(window.location.href).then(() => alert("é“¾æ¥å·²å¤åˆ¶"));
    }

    function exportCSV() {
        if (!entries.length) return alert("ç©ºè®°å½•");
        let csv = "\uFEFFæ—¥æœŸ,åŸæ–‡,æ‹†è§£,æ„Ÿæ‚Ÿ\n";
        entries.forEach(e => {
            const q = (e.quote || '').replace(/"/g, '""');
            const i = (e.insight || '').replace(/"/g, '""');
            const f = (e.feeling || '').replace(/"/g, '""');
            csv += `"${e.dateRaw}","${q}","${i}","${f}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `ç¬”è®°_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    function parseCSVLine(text) {
        const result = [];
        let cur = '';
        let inQuote = false;
        for (let n = 0; n < text.length; n++) {
            const char = text[n];
            const next = text[n + 1];
            if (char === '"' && inQuote && next === '"') { cur += '"'; n++; }
            else if (char === '"') { inQuote = !inQuote; }
            else if (char === ',' && !inQuote) { result.push(cur); cur = ''; }
            else { cur += char; }
        }
        result.push(cur);
        return result;
    }

    // --- æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨è§£æ DD-MM-YY æ ¼å¼ ---
    function importCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const lines = content.split(/\r?\n/);
            let count = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || (i === 0 && line.includes("æ—¥æœŸ"))) continue; 

                const parts = parseCSVLine(line);
                
                if (parts && parts.length >= 1) {
                    let rawDateStr = parts[0].trim().replace(/^\uFEFF/, ""); 
                    
                    // æ‹†åˆ†æ—¥æœŸå­—ç¬¦ä¸² (æ”¯æŒ - æˆ– / åˆ†éš”)
                    const dateParts = rawDateStr.split(/[-/.]/);
                    
                    let dObj, dateRaw;

                    if (dateParts.length === 3) {
                        // é€»è¾‘ï¼šå‡è®¾è¾“å…¥æ˜¯ DD-MM-YY æˆ– DD-MM-YYYY
                        let day = dateParts[0].padStart(2, '0');
                        let month = dateParts[1].padStart(2, '0');
                        let year = dateParts[2];

                        // å¤„ç†ä¸¤ä½æ•°å¹´ä»½ (å¦‚æœæ˜¯ 24 å˜æˆ 2024)
                        if (year.length === 2) year = "20" + year;

                        // æ„å»ºæ ‡å‡†çš„ YYYY-MM-DD
                        dateRaw = `${year}-${month}-${day}`;
                        dObj = new Date(dateRaw);
                    } else {
                        // å¦‚æœæ ¼å¼å®Œå…¨ä¸ç¬¦ï¼Œé€€å›åˆ°åŸå§‹è§£æ
                        dObj = new Date(rawDateStr);
                        if (!isNaN(dObj.getTime())) {
                            dateRaw = dObj.getFullYear() + '-' + 
                                     String(dObj.getMonth() + 1).padStart(2, '0') + '-' + 
                                     String(dObj.getDate()).padStart(2, '0');
                        }
                    }

                    if (!dObj || isNaN(dObj.getTime())) continue;

                    const quote = (parts[1] || "").trim();
                    const insight = (parts[2] || "").trim();
                    const feeling = (parts[3] || "").trim();

                    if (!entries.some(e => e.dateRaw === dateRaw && e.quote === quote)) {
                        entries.push({ 
                            dateRaw, 
                            quote, 
                            insight, 
                            feeling, 
                            timestamp: dObj.getTime() 
                        });
                        count++;
                    }
                }
            }
            entries.sort((a, b) => b.timestamp - a.timestamp);
            localStorage.setItem('moti_notes', JSON.stringify(entries));
            renderEntries();
            alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡æ–°è®°å½•ï¼`);
            input.value = '';
        };
        reader.readAsText(file);
    }

    initDatePicker();
    renderEntries();
</script>

</body>
</html>
